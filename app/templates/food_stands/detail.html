{% extends "base.html" %}

{% block title %}{{ stand.name }} - Quadra{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('food_stands.list_stands') }}">Puestos</a></li>
            <li class="breadcrumb-item active">{{ stand.name }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Información del puesto -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <!-- Imagen del puesto -->
                    {% if stand.image_filename %}
                    <img src="{{ url_for('static', filename='uploads/' + stand.image_filename) }}" 
                         class="img-fluid rounded mb-4" alt="{{ stand.name }}" style="max-height: 400px; width: 100%; object-fit: cover;">
                    {% else %}
                    <div class="bg-light rounded mb-4 d-flex align-items-center justify-content-center" style="height: 300px;">
                        <i class="bi bi-image text-muted" style="font-size: 4rem;"></i>
                    </div>
                    {% endif %}

                    <!-- Información básica -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h1 class="h2 fw-bold mb-2">{{ stand.name }}</h1>
                            <div class="d-flex align-items-center mb-2">
                                {% if stand.average_rating > 0 %}
                                <div class="text-warning me-2">
                                    {% for i in range(5) %}
                                        {% if i < stand.average_rating %}
                                            <i class="bi bi-star-fill"></i>
                                        {% else %}
                                            <i class="bi bi-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <span class="fw-bold">{{ "%.1f"|format(stand.average_rating) }}</span>
                                <span class="text-muted ms-1">({{ stand.total_reviews }} reseñas)</span>
                                {% else %}
                                <span class="text-muted">Sin calificaciones aún</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if current_user.id == stand.user_id %}
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#"><i class="bi bi-pencil"></i> Editar</a></li>
                                <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-trash"></i> Eliminar</a></li>
                            </ul>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Descripción -->
                    <p class="lead mb-4">{{ stand.description }}</p>

                    <!-- Información adicional -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-circle text-primary me-2"></i>
                                <div>
                                    <small class="text-muted">Propietario</small>
                                    <div class="fw-semibold">{{ stand.owner.username }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-calendar text-primary me-2"></i>
                                <div>
                                    <small class="text-muted">Agregado</small>
                                    <div class="fw-semibold">{{ stand.created_at.strftime('%d/%m/%Y') }}</div>
                                </div>
                            </div>
                        </div>
                        
                        {% if stand.address %}
                        <div class="col-12">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-geo-alt text-primary me-2"></i>
                                <div>
                                    <small class="text-muted">Dirección</small>
                                    <div class="fw-semibold">{{ stand.address }}</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Reseñas -->
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h3 class="h5 mb-0">
                        <i class="bi bi-star"></i> Reseñas 
                        <span class="badge bg-primary">{{ reviews|length }}</span>
                    </h3>
                </div>
                
                <div class="card-body">
                    {% if reviews %}
                        {% for review in reviews %}
                        <div class="review-item border-bottom pb-3 mb-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <div class="fw-semibold">{{ review.author.username }}</div>
                                        <div class="text-warning">
                                            {% for i in range(5) %}
                                                {% if i < review.rating %}
                                                    <i class="bi bi-star-fill"></i>
                                                {% else %}
                                                    <i class="bi bi-star"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted">{{ review.created_at.strftime('%d/%m/%Y') }}</small>
                            </div>
                            {% if review.comment %}
                            <p class="mb-0">{{ review.comment }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-chat-quote text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2">Aún no hay reseñas para este puesto.</p>
                            {% if current_user.id != stand.user_id and not user_review %}
                            <p class="text-muted">¡Sé el primero en dejar una reseña!</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Mapa -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Ubicación</h5>
                </div>
                <div class="card-body p-0">
                    <div id="standMap" style="height: 250px;"></div>
                </div>
            </div>

            <!-- Formulario de reseña -->
            {% if current_user.is_authenticated and current_user.id != stand.user_id %}
                {% if not user_review %}
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-star"></i> Dejar una reseña</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('food_stands.add_review', id=stand.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="mb-3">
                                <label class="form-label">Calificación</label>
                                <div class="rating-input">
                                    {% for i in range(1, 6) %}
                                    <input type="radio" name="rating" value="{{ i }}" id="star{{ i }}" required>
                                    <label for="star{{ i }}" class="star-label">
                                        <i class="bi bi-star"></i>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="comment" class="form-label">Comentario (opcional)</label>
                                <textarea class="form-control" id="comment" name="comment" rows="3" 
                                          placeholder="Comparte tu experiencia con este puesto..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-send"></i> Enviar Reseña
                            </button>
                        </form>
                    </div>
                </div>
                {% else %}
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-check-circle"></i> Tu reseña</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center">
                            <div class="text-warning mb-2">
                                {% for i in range(5) %}
                                    {% if i < user_review.rating %}
                                        <i class="bi bi-star-fill"></i>
                                    {% else %}
                                        <i class="bi bi-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            {% if user_review.comment %}
                            <p class="mb-3">"{{ user_review.comment }}"</p>
                            {% endif %}
                            <small class="text-muted">Reseña enviada el {{ user_review.created_at.strftime('%d/%m/%Y') }}</small>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% elif not current_user.is_authenticated %}
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <i class="bi bi-star text-warning mb-3" style="font-size: 3rem;"></i>
                    <h5>¿Conoces este puesto?</h5>
                    <p class="text-muted">Inicia sesión para dejar una reseña y ayudar a otros usuarios.</p>
                    <a href="{{ url_for('auth.login') }}" class="btn btn-primary">
                        <i class="bi bi-box-arrow-in-right"></i> Iniciar Sesión
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet para el mapa -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Configurar íconos de Leaflet para evitar errores 404
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
    iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png',
    iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
});

// Mapa del puesto
const standMap = L.map('standMap').setView([{{ stand.latitude }}, {{ stand.longitude }}], 15);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(standMap);

// Marcador del puesto
L.marker([{{ stand.latitude }}, {{ stand.longitude }}])
    .addTo(standMap)
    .bindPopup('<b>{{ stand.name }}</b><br>{{ stand.address if stand.address else "Ubicación del puesto" }}');

// Sistema de calificación con estrellas
document.querySelectorAll('.rating-input input[type="radio"]').forEach(input => {
    input.addEventListener('change', function() {
        const rating = parseInt(this.value);
        const labels = document.querySelectorAll('.star-label');
        
        labels.forEach((label, index) => {
            const star = label.querySelector('i');
            if (index < rating) {
                star.className = 'bi bi-star-fill';
                label.style.color = '#ffc107';
            } else {
                star.className = 'bi bi-star';
                label.style.color = '#6c757d';
            }
        });
    });
});

// Hover effect para las estrellas
document.querySelectorAll('.star-label').forEach((label, index) => {
    label.addEventListener('mouseenter', function() {
        const labels = document.querySelectorAll('.star-label');
        labels.forEach((l, i) => {
            const star = l.querySelector('i');
            if (i <= index) {
                star.className = 'bi bi-star-fill';
                l.style.color = '#ffc107';
            } else {
                star.className = 'bi bi-star';
                l.style.color = '#6c757d';
            }
        });
    });
});

// Reset al salir del área de rating
document.querySelector('.rating-input').addEventListener('mouseleave', function() {
    const checkedInput = this.querySelector('input[type="radio"]:checked');
    if (checkedInput) {
        checkedInput.dispatchEvent(new Event('change'));
    } else {
        document.querySelectorAll('.star-label').forEach(label => {
            const star = label.querySelector('i');
            star.className = 'bi bi-star';
            label.style.color = '#6c757d';
        });
    }
});
</script>

<style>
.rating-input {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
}

.rating-input input[type="radio"] {
    display: none;
}

.star-label {
    cursor: pointer;
    font-size: 1.5rem;
    color: #6c757d;
    transition: color 0.2s;
}

.star-label:hover {
    color: #ffc107;
}

.review-item:last-child {
    border-bottom: none !important;
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
}
</style>
{% endblock %}
